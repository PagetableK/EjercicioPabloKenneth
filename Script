#SCRIPT DE LA DB
DROP DATABASE IF EXISTS QuickBite;

CREATE DATABASE QuickBite;

USE QuickBite;

CREATE TABLE clientes(
	cliente_id VARCHAR(36) PRIMARY KEY,
	nombre VARCHAR(50) NOT NULL,
	apellido VARCHAR(50) NOT NULL,
	telefono VARCHAR(10) UNIQUE,
	direccion VARCHAR(255) NOT NULL
);

CREATE TABLE empleados(
	empleado_id VARCHAR(36) PRIMARY KEY,
	nombre VARCHAR(50) NOT NULL,
	apellido VARCHAR(50) NOT NULL,
	cargo VARCHAR(50) NOT NULL,
	fecha_contratacion DATE NOT NULL,
	salario DECIMAL(10,2),
	CHECK(salario >= 365)
);

CREATE TABLE pedidos(
	pedido_id VARCHAR(36) PRIMARY KEY,
	cliente_id VARCHAR(36) NOT NULL,
	fecha_pedido DATE NOT NULL,
	total DECIMAL(10,2) NOT NULL,
	estado ENUM('Enviando', 'Enviado', 'Cancelado') NOT NULL,
	empleado_id VARCHAR(36) NOT NULL,
	FOREIGN KEY (cliente_id)
	REFERENCES clientes(cliente_id),
	FOREIGN KEY (empleado_id)
	REFERENCES empleados(empleado_id)
);

CREATE TABLE productos(
	producto_id VARCHAR(36) PRIMARY KEY,
	nombre VARCHAR(100) NOT NULL,
	descripcion VARCHAR(500) NOT NULL,
	precio DECIMAL(10,2) NOT NULL,
	CHECK(precio >= 1),
	existencias INT NOT NULL,
	CHECK(existencias>=0)
);

CREATE TABLE detalles_pedidos(
	detalle_id VARCHAR(36) PRIMARY KEY,
	pedido_id VARCHAR(36) NOT NULL,
	producto_id VARCHAR(36) NOT NULL,
	cantidad INT NOT NULL,
	precio_unitario DECIMAL(10,2) NOT NULL,
	subtotal DECIMAL(10,2) NOT NULL,
	FOREIGN KEY (pedido_id)
	REFERENCES pedidos(pedido_id),
	FOREIGN KEY (producto_id)
	REFERENCES productos(producto_id)
);

-- TRIGGER QUE DISMINUYE LA CANTIDAD DE PRODUCTOS
-- CUANDO SE EJECUTA 1 INSERT EN detalles_pedidos

CREATE TRIGGER disminuir_existencia 
AFTER INSERT ON detalles_pedidos
FOR EACH ROW
UPDATE productos
SET existencias = existencias - NEW.cantidad
WHERE producto_id = NEW.producto_id;



-- INSERTS NECESARIOS PARA EJECUTAR EL TRIGGER

INSERT INTO empleados VALUES(UUID(), 'Kenneth', 'Ramos', 'Jefe', '2022-01-01', 1000);
INSERT INTO productos VALUES(UUID(), 'Licuadora', 'Licuadora chiva de 1000W', 100.00, 5);
INSERT INTO clientes VALUES(UUID(), 'Pablo', 'Sánchez', '12345678', 'Av. Calle');

-- 											 		*INSERTE ID DEL CLIENTE*
INSERT INTO pedidos VALUES(UUID(), '2792ec60-d656-11ee-8955-a4bb6dda87ba', '2020-05-04', 200.00, 
--						*INSERTE ID DEL EMPLEADO*
'Enviando', 'c01fba02-d652-11ee-8955-a4bb6dda87ba');

--																*INSERTE ID DEL PEDIDO*
INSERT INTO detalles_pedidos VALUES(UUID(), '3f8a60c7-d656-11ee-8955-a4bb6dda87ba', 
--		*INSERTE ID DEL PRODUCTO*
'c02031b6-d652-11ee-8955-a4bb6dda87ba', 2, 100.00, 200.00);

-- Procedimiento almacenado


-- Insertar valores en la tabla clientes los 15 por tabla
-- Insertar valores en la tabla cliente
DELIMITER $$
CREATE PROCEDURE insertar_clientes_multiples()
BEGIN
    DECLARE i INT DEFAULT 1;
    WHILE i <= 15 DO
        INSERT INTO clientes VALUES(UUID(), CONCAT('Cliente', i), CONCAT('Apellido', i), CONCAT('1234567', i), CONCAT('Dirección', i));
        SET i = i + 1;
    END WHILE;
END$$
DELIMITER ;
CALL insertar_clientes_multiples();

-- Insertar valores en la tabla empleados
DELIMITER $$
CREATE PROCEDURE insertar_empleados_multiples()
BEGIN
    DECLARE i INT DEFAULT 1;
    WHILE i <= 15 DO
        INSERT INTO empleados VALUES(UUID(), CONCAT('Empleado', i), CONCAT('Apellido', i), CONCAT('Cargo', i), '2022-01-01', 1000);
        SET i = i + 1;
    END WHILE;
END$$
DELIMITER ;
CALL insertar_empleados_multiples();

-- Insertar valores en la tabla pedidos
DELIMITER $$
CREATE PROCEDURE insertar_pedidos_multiples()
BEGIN
    DECLARE i INT DEFAULT 1;
    WHILE i <= 15 DO
        INSERT INTO pedidos VALUES(UUID(), (SELECT cliente_id FROM clientes ORDER BY RAND() LIMIT 1), '2024-02-28', 100.00 * i, 'Enviando', (SELECT empleado_id FROM empleados ORDER BY RAND() LIMIT 1));
        SET i = i + 1;
    END WHILE;
END$$
DELIMITER ;
CALL insertar_pedidos_multiples();

-- Insertar valores en la tabla productos
DELIMITER $$
CREATE PROCEDURE insertar_productos_multiples()
BEGIN
    DECLARE i INT DEFAULT 1;
    WHILE i <= 15 DO
        INSERT INTO productos VALUES(UUID(), CONCAT('Producto', i), CONCAT('Descripción', i), 10.00 * i, 50);
        SET i = i + 1;
    END WHILE;
END$$
DELIMITER ;
CALL insertar_productos_multiples();

-- Insertar valores en la tabla detalle pedidos
DELIMITER $$
CREATE PROCEDURE insertar_detalles_pedidos_multiples()
BEGIN
    DECLARE i INT DEFAULT 1;
    WHILE i <= 15 DO
        INSERT INTO detalles_pedidos VALUES(UUID(), (SELECT pedido_id FROM pedidos ORDER BY RAND() LIMIT 1), (SELECT producto_id FROM productos ORDER BY RAND() LIMIT 1), i, 10.00 * i, 100.00 * i);
        SET i = i + 1;
    END WHILE;
END$$
DELIMITER ;
CALL insertar_detalles_pedidos_multiples();



SELECT * FROM clientes;
SELECT * FROM empleados;
SELECT * FROM pedidos;
SELECT * FROM productos;
SELECT * FROM detalles_pedidos;

 
