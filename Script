#SCRIPT DE LA DB
DROP DATABASE IF EXISTS QuickBite;

CREATE DATABASE QuickBite;

USE QuickBite;

CREATE TABLE clientes(
	cliente_id VARCHAR(36) PRIMARY KEY,
	nombre VARCHAR(50),
	apellido VARCHAR(50),
	telefono VARCHAR(10),
	direccion VARCHAR(255)
);

CREATE TABLE empleados(
	empleado_id VARCHAR(36) PRIMARY KEY,
	nombre VARCHAR(50),
	apellido VARCHAR(50),
	cargo VARCHAR(50),
	fecha_contratacion DATE,
	salario DECIMAL(10,2)
);

CREATE TABLE pedidos(
	pedido_id VARCHAR(36) PRIMARY KEY,
	cliente_id VARCHAR(36),
	fecha_pedido DATE,
	total DECIMAL(10,2),
	estado VARCHAR(20),
	empleado_id VARCHAR(36),
	FOREIGN KEY (cliente_id)
	REFERENCES clientes(cliente_id),
	FOREIGN KEY (empleado_id)
	REFERENCES empleados(empleado_id)
);

CREATE TABLE productos(
	producto_id VARCHAR(36) PRIMARY KEY,
	nombre VARCHAR(100),
	descripcion VARCHAR(500),
	precio DECIMAL(10,2),
	existencias INT
);

CREATE TABLE detalles_pedidos(
	detalle_id VARCHAR(36) PRIMARY KEY,
	pedido_id VARCHAR(36),
	producto_id VARCHAR(36),
	cantidad INT,
	precio_unitario DECIMAL(10,2),
	subtotal DECIMAL(10,2),
	FOREIGN KEY (pedido_id)
	REFERENCES pedidos(pedido_id),
	FOREIGN KEY (producto_id)
	REFERENCES productos(producto_id)
);

-- TRIGGER QUE DISMINUYE LA CANTIDAD DE PRODUCTOS
-- CUANDO SE EJECUTA 1 INSERT EN detalles_pedidos

CREATE TRIGGER disminuir_existencia 
AFTER INSERT ON detalles_pedidos
FOR EACH ROW
UPDATE productos
SET existencias = existencias - NEW.cantidad
WHERE producto_id = NEW.producto_id;

-- INSERTS NECESARIOS PARA EJECUTAR EL TRIGGER

INSERT INTO empleados VALUES(UUID(), 'Kenneth', 'Ramos', 'Jefe', '2022-01-01', 1000);
INSERT INTO productos VALUES(UUID(), 'Licuadora', 'Licuadora chiva de 1000W', 100.00, 5);

-- 											 		*INSERTE ID DEL CLIENTE*
INSERT INTO pedidos VALUES(UUID(), '38b2b820-d64e-11ee-8955-a4bb6dda87ba', '2020-05-04', 200.00, 
--						*INSERTE ID DEL EMPLEADO*
'Enviando', '5015a6fd-d64f-11ee-8955-a4bb6dda87ba');

--																*INSERTE ID DEL PEDIDO*
INSERT INTO detalles_pedidos VALUES(UUID(), '1a6084c2-d650-11ee-8955-a4bb6dda87ba', 
--		*INSERTE ID DEL PRODUCTO*
'cdadaca3-d64f-11ee-8955-a4bb6dda87ba', 2, 100.00, 200.00);
